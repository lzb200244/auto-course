<!DOCTYPE html>
<html>
<head>
    <title>七牛云对象存储图片上传示例</title>
</head>
<body>
<h1>图片上传示例</h1>
<form id="upload-form">
    <input type="file" id="file-input" accept="image/*">
    <button type="button" onclick="uploadImage()">上传图片</button>
</form>
<div id="image-preview"></div>

<script src="https://cdn.bootcdn.net/ajax/libs/qiniu-js/2.2.2/qiniu.min.js"></script>
</body>
</html>
<script>
    // upload.js

    // 从你的配置文件中获取七牛云的参数
    const { accessKey, secretKey, bucketName } = qiniuConfig;

    // 初始化七牛云 SDK
    const config = new qiniu.conf.Config();
    const formUploader = new qiniu.form_up.FormUploader(config);
    const putExtra = new qiniu.form_up.PutExtra();

    // 获取文件输入元素和预览元素
    const fileInput = document.getElementById('file-input');
    const imagePreview = document.getElementById('image-preview');

    // 监听文件选择事件
    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
            // 预览选定的图片
            const imgUrl = URL.createObjectURL(file);
            imagePreview.innerHTML = `<img src="${imgUrl}" alt="预览图片">`;
        }
    });

    // 处理图片上传
    function uploadImage() {
        const file = fileInput.files[0];
        if (file) {
            // 生成上传 Token
            const token = generateToken(accessKey, secretKey, bucketName);

            // 构建文件上传表单
            const key = `${Date.now()}_${file.name}`;
            const putExtra = new qiniu.form_up.PutExtra();
            const config = new qiniu.conf.Config();
            const observable = qiniu.upload(file, key, token, putExtra, config);

            // 监听上传进度
            observable.subscribe({
                next: (response) => {
                    const percent = response.total.percent;
                    console.log(`上传进度：${percent}%`);
                },
                error: (error) => {
                    console.error('上传失败：', error);
                },
                complete: (response) => {
                    console.log('上传成功：', response.key);
                },
            });
        }
    }

    // 生成上传 Token
    function generateToken(accessKey, secretKey, bucketName) {
        const mac = new qiniu.auth.digest.Mac(accessKey, secretKey);
        const options = {
            scope: bucketName,
        };
        const putPolicy = new qiniu.rs.PutPolicy(options);
        return putPolicy.uploadToken(mac);
    }

</script>
